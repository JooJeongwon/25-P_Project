services:
  # 1. 백엔드 (Java/Spring)
  # backend:
  #   build: ./backend
  #   container_name: hyodream-backend
  #   ports:
  #     - "8080:8080"
  #   environment:
  #     - TZ=Asia/Seoul
  #     - SPRING_DATASOURCE_URL=jdbc:mysql://mysql-db:3306/hyodream_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=UTF-8
  #     - SPRING_DATASOURCE_USERNAME=root
  #     - SPRING_DATASOURCE_PASSWORD=root
  #   depends_on:
  #     - mysql-db
  #   networks:
  #     - hyodream

  # 2. AI 서버 (기본) - Host Port: 8000
  ai-server:
    build:
      context: ./ai-server
      dockerfile: Dockerfile
    container_name: hyodream-ai
    env_file:
      - .env
    ports:
      - "8000:8000" # 외부 8000 -> 내부 8000
    environment:
      - TZ=Asia/Seoul
    networks:
      - hyodream

  # 3. AI 리뷰 서버 (Review Analysis) - Host Port: 8001
  ai-review:
    build:
      context: ./ai-review
      dockerfile: Dockerfile
    container_name: hyodream-ai-review
    ports:
      - "8001:8000" # 외부 8001 -> 내부 8000 (포트 충돌 방지)
    environment:
      - TZ=Asia/Seoul
    networks:
      - hyodream

  # 4. 크롤러 (Crawler/Chrome) - Host Port: 8002
  crawler:
    platform: linux/amd64
    build:
      context: ./crawler
      dockerfile: Dockerfile
    container_name: hyodream-crawler
    ports:
      - "8002:8000" # 외부 8002 -> 내부 8000 (포트 충돌 방지)
    environment:
      - TZ=Asia/Seoul
    # 크롬 사용 시 공유 메모리 부족 에러 방지를 위한 설정 (필수 권장)
    shm_size: '2gb'
    networks:
      - hyodream

  # 5. 데이터베이스 (MySQL)
  mysql-db:
    image: mysql:8.0
    container_name: hyodream-mysql
    ports:
      - "3306:3306"
    environment:
      - TZ=Asia/Seoul
      - MYSQL_ROOT_PASSWORD=root
      - MYSQL_DATABASE=hyodream_db
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    volumes:
      - mysql-data:/var/lib/mysql
    networks:
      - hyodream

  # 6. Redis 캐시
  redis-cache:
    image: redis:alpine
    container_name: hyodream-redis
    ports:
      - "6379:6379"
    command: redis-server --protected-mode no
    networks:
      - hyodream

networks:
  hyodream:
    driver: bridge

volumes:
  mysql-data:
